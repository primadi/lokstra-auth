### ============================================================
### Credential Provider Service Tests
### ============================================================
### Manages OAuth2/SAML/Email provider configurations
### Supports multiple provider configs per tenant+app
### ============================================================

@baseUrl = http://localhost:8080
@apiPrefix = /api/auth
@tenantId = demo-tenant
@appId = web-portal

### ------------------------------------------------------------
### 1. CREATE - Tenant-level Google OAuth2 Provider (Default)
### ------------------------------------------------------------
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "",
  "type": "oauth2_google",
  "name": "Google OAuth (Tenant Default)",
  "description": "Default Google OAuth2 configuration for all apps",
  "config": {
    "client_id": "123456789-abc.apps.googleusercontent.com",
    "client_secret": "GOCSPX-secret-tenant-default",
    "redirect_uri": "https://auth.example.com/callback/google",
    "scopes": ["openid", "profile", "email"]
  }
}

### ------------------------------------------------------------
### 2. CREATE - App-level Google OAuth2 Provider (Web Portal)
### ------------------------------------------------------------
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "{{appId}}",
  "type": "oauth2_google",
  "name": "Google OAuth (Web Portal)",
  "description": "Google OAuth2 configuration specific for web portal",
  "config": {
    "client_id": "987654321-web.apps.googleusercontent.com",
    "client_secret": "GOCSPX-secret-web-portal",
    "redirect_uri": "https://web.example.com/callback/google",
    "scopes": ["openid", "profile", "email", "https://www.googleapis.com/auth/calendar"]
  },
  "metadata": {
    "environment": "production",
    "version": "v2"
  }
}

### ------------------------------------------------------------
### 3. CREATE - App-level GitHub OAuth2 Provider (Mobile App)
### ------------------------------------------------------------
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "mobile-app",
  "type": "oauth2_github",
  "name": "GitHub OAuth (Mobile App)",
  "description": "GitHub OAuth2 configuration for mobile application",
  "config": {
    "client_id": "Iv1.mobile-app-client-id",
    "client_secret": "github-secret-mobile-app",
    "redirect_uri": "https://mobile.example.com/callback/github",
    "scopes": ["read:user", "user:email"]
  }
}

### ------------------------------------------------------------
### 4. CREATE - SAML Provider
### ------------------------------------------------------------
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "",
  "type": "saml",
  "name": "Corporate SAML IdP",
  "description": "Enterprise SAML identity provider",
  "config": {
    "entity_id": "https://sso.example.com/saml/metadata",
    "sso_url": "https://sso.example.com/saml/sso",
    "certificate": "-----BEGIN CERTIFICATE-----\nMIIC...\n-----END CERTIFICATE-----",
    "attributes_mapping": {
      "email": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress",
      "first_name": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname",
      "last_name": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname"
    }
  }
}

### ------------------------------------------------------------
### 5. CREATE - Email Provider (SMTP)
### ------------------------------------------------------------
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "",
  "type": "email",
  "name": "SendGrid SMTP",
  "description": "SendGrid email service for magic link authentication",
  "config": {
    "smtp_host": "smtp.sendgrid.net",
    "smtp_port": 587,
    "smtp_username": "apikey",
    "smtp_password": "SG.secret-api-key",
    "from_email": "noreply@example.com",
    "from_name": "Example App"
  }
}

### ------------------------------------------------------------
### 6. GET - Retrieve Provider by ID
### ------------------------------------------------------------
@providerId = google-web-portal
GET {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/{{providerId}}

### ------------------------------------------------------------
### 7. LIST - All Providers for Tenant
### ------------------------------------------------------------
GET {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers

### ------------------------------------------------------------
### 8. LIST - Providers for Specific App (includes tenant-level)
### ------------------------------------------------------------
GET {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers?app_id={{appId}}

### ------------------------------------------------------------
### 9. LIST BY TYPE - All Google OAuth2 Providers
### ------------------------------------------------------------
GET {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/by-type/oauth2_google

### ------------------------------------------------------------
### 10. LIST BY TYPE - Google OAuth2 for Specific App
### ------------------------------------------------------------
GET {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/by-type/oauth2_google?app_id={{appId}}

### ------------------------------------------------------------
### 11. GET ACTIVE PROVIDER - For App (app-level override)
### ------------------------------------------------------------
GET {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/active?app_id={{appId}}&type=oauth2_google

### ------------------------------------------------------------
### 12. GET ACTIVE PROVIDER - Fallback to Tenant-level
### ------------------------------------------------------------
GET {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/active?app_id=other-app&type=oauth2_google

### ------------------------------------------------------------
### 13. UPDATE - Modify Provider Configuration
### ------------------------------------------------------------
@updateProviderId = google-web-portal
PUT {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/{{updateProviderId}}
Content-Type: application/json

{
  "name": "Google OAuth (Web Portal - Updated)",
  "description": "Updated Google OAuth2 configuration",
  "config": {
    "client_id": "987654321-web-updated.apps.googleusercontent.com",
    "client_secret": "GOCSPX-secret-web-portal-updated",
    "redirect_uri": "https://web.example.com/auth/google/callback",
    "scopes": ["openid", "profile", "email"]
  }
}

### ------------------------------------------------------------
### 14. DISABLE - Disable Provider
### ------------------------------------------------------------
@disableProviderId = google-web-portal
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/{{disableProviderId}}/disable

### ------------------------------------------------------------
### 15. ENABLE - Re-enable Provider
### ------------------------------------------------------------
@enableProviderId = google-web-portal
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/{{enableProviderId}}/enable

### ------------------------------------------------------------
### 16. DELETE - Remove Provider
### ------------------------------------------------------------
@deleteProviderId = google-tenant-default
DELETE {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/{{deleteProviderId}}

### ============================================================
### ADVANCED USE CASES
### ============================================================

### ------------------------------------------------------------
### UC1: Multi-Environment Setup
### ------------------------------------------------------------
### Create dev, staging, prod Google OAuth2 providers

POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "web-portal",
  "type": "oauth2_google",
  "name": "Google OAuth (Development)",
  "config": {
    "client_id": "dev-client-id.apps.googleusercontent.com",
    "client_secret": "dev-secret",
    "redirect_uri": "http://localhost:3000/callback/google",
    "scopes": ["openid", "profile", "email"]
  },
  "metadata": {
    "environment": "development"
  }
}

###

POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "web-portal",
  "type": "oauth2_google",
  "name": "Google OAuth (Production)",
  "config": {
    "client_id": "prod-client-id.apps.googleusercontent.com",
    "client_secret": "prod-secret",
    "redirect_uri": "https://app.example.com/callback/google",
    "scopes": ["openid", "profile", "email"]
  },
  "metadata": {
    "environment": "production"
  }
}

### ------------------------------------------------------------
### UC2: Multiple Social Providers for One App
### ------------------------------------------------------------

# Google
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "{{appId}}",
  "type": "oauth2_google",
  "name": "Google OAuth",
  "config": {
    "client_id": "google-client.apps.googleusercontent.com",
    "client_secret": "google-secret",
    "redirect_uri": "https://app.example.com/callback/google",
    "scopes": ["openid", "profile", "email"]
  }
}

###

# GitHub
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "{{appId}}",
  "type": "oauth2_github",
  "name": "GitHub OAuth",
  "config": {
    "client_id": "github-client-id",
    "client_secret": "github-secret",
    "redirect_uri": "https://app.example.com/callback/github",
    "scopes": ["read:user", "user:email"]
  }
}

###

# Microsoft
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "{{appId}}",
  "type": "oauth2_microsoft",
  "name": "Microsoft OAuth",
  "config": {
    "client_id": "microsoft-client-id",
    "client_secret": "microsoft-secret",
    "redirect_uri": "https://app.example.com/callback/microsoft",
    "scopes": ["openid", "profile", "email"],
    "tenant": "common"
  }
}

### ------------------------------------------------------------
### UC3: Tenant-level Default + App-level Override
### ------------------------------------------------------------

# Step 1: Create tenant-level default Google provider
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "",
  "type": "oauth2_google",
  "name": "Google OAuth (Tenant Default)",
  "config": {
    "client_id": "tenant-default.apps.googleusercontent.com",
    "client_secret": "tenant-default-secret",
    "redirect_uri": "https://auth.example.com/callback/google",
    "scopes": ["openid", "profile", "email"]
  }
}

###

# Step 2: Create app-level override for web-portal
POST {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers
Content-Type: application/json

{
  "app_id": "web-portal",
  "type": "oauth2_google",
  "name": "Google OAuth (Web Portal Override)",
  "config": {
    "client_id": "web-portal.apps.googleusercontent.com",
    "client_secret": "web-portal-secret",
    "redirect_uri": "https://web.example.com/callback/google",
    "scopes": ["openid", "profile", "email", "https://www.googleapis.com/auth/drive.readonly"]
  }
}

###

# Step 3: Verify web-portal uses override
GET {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/active?app_id=web-portal&type=oauth2_google

###

# Step 4: Verify other apps use tenant default
GET {{baseUrl}}{{apiPrefix}}/core/tenants/{{tenantId}}/credential-providers/active?app_id=mobile-app&type=oauth2_google
