### Credential Config Service API Tests
### Manages credential provider configuration at tenant and app levels
@baseUrl = http://localhost:9090/api/auth/core/config/credentials/tenants/{{tenantId}}
@contentType = application/json
@tenantId = acme-corp
@appId = main-app

# =============================================================================
# TENANT-LEVEL DEFAULT CREDENTIAL CONFIG
# These configs apply to all apps in the tenant unless overridden
# =============================================================================

### 1. Get Tenant Default Credential Config
# Returns tenant default or global default if not set
GET {{baseUrl}}

### 2. Update Tenant Default - Enable Basic + OAuth2
# Best Practice: Enable multiple credential types for flexibility
PUT {{baseUrl}}
Content-Type: {{contentType}}

{
  "config": {
    "enable_basic": true,
    "basic_config": {
      "min_username_length": 3,
      "max_username_length": 32,
      "min_password_length": 12,
      "require_strong_pwd": true,
      "max_login_attempts": 5,
      "lockout_duration_secs": 600,
      "session_timeout_secs": 3600
    },
    "enable_oauth2": true,
    "oauth2_config": {
      "providers": [
        {
          "name": "google",
          "enabled": true,
          "client_id": "your-google-client-id.apps.googleusercontent.com",
          "client_secret": "GOCSPX-your-secret",
          "scopes": ["openid", "email", "profile"]
        }
      ],
      "callback_url": "http://localhost:9090//api/auth/cred/oauth2/callback",
      "state_expiry_secs": 600,
      "session_timeout_secs": 7200
    },
    "enable_apikey": true,
    "apikey_config": {
      "secret_length": 32,
      "hash_algo": "sha3-256",
      "default_expiry_days": 365,
      "allow_never_expire": true,
      "rate_limit_per_minute": 120
    },
    "enable_passwordless": false,
    "enable_passkey": false
  }
}

### 3. Update Tenant Default - Enable Passwordless
# Best Practice: Passwordless for better UX
PUT {{baseUrl}}
Content-Type: {{contentType}}

{
  "config": {
    "enable_basic": true,
    "enable_passwordless": true,
    "passwordless_config": {
      "enable_email": true,
      "enable_sms": false,
      "code_length": 6,
      "code_expiry_secs": 300,
      "link_expiry_secs": 600,
      "max_attempts_per_email": 3,
      "max_attempts_per_phone": 3,
      "cooldown_secs": 60
    }
  }
}

### 4. Update Tenant Default - Enable Passkey (WebAuthn)
# Best Practice: Passkey for strongest security
PUT {{baseUrl}}
Content-Type: {{contentType}}

{
  "config": {
    "enable_basic": true,
    "enable_passkey": true,
    "passkey_config": {
      "rp_name": "Acme Corporation",
      "rp_id": "localhost",
      "rp_origins": ["http://localhost:9090"],
      "require_resident_key": false,
      "user_verification": "preferred",
      "attestation_preference": "none",
      "timeout_secs": 60
    }
  }
}

# =============================================================================
# APP-LEVEL CREDENTIAL CONFIG
# Override tenant defaults for specific apps
# =============================================================================

### 5. Get App-Specific Credential Config
# Returns app config or falls back to tenant default
GET {{baseUrl}}/apps/{{appId}}

### 6. Update App Config - Strict Security for Production App
# Best Practice: Stricter password policy for production
PUT {{baseUrl}}/apps/{{appId}}
Content-Type: {{contentType}}

{
  "config": {
    "enable_basic": true,
    "basic_config": {
      "min_username_length": 5,
      "max_username_length": 50,
      "min_password_length": 16,
      "require_strong_pwd": true,
      "max_login_attempts": 3,
      "lockout_duration_secs": 1800,
      "session_timeout_secs": 1800
    },
    "enable_oauth2": true,
    "oauth2_config": {
      "providers": [
        {
          "name": "google",
          "enabled": true,
          "client_id": "prod-google-client-id.apps.googleusercontent.com",
          "client_secret": "GOCSPX-prod-secret",
          "scopes": ["openid", "email", "profile"]
        },
        {
          "name": "azure",
          "enabled": true,
          "client_id": "azure-client-id",
          "client_secret": "azure-secret",
          "scopes": ["openid", "email", "profile"],
          "auth_url": "https://login.microsoftonline.com/common/oauth2/v2.0/authorize",
          "token_url": "https://login.microsoftonline.com/common/oauth2/v2.0/token"
        }
      ],
      "callback_url": "https://api.acme-corp.com//api/auth/cred/oauth2/callback",
      "state_expiry_secs": 300,
      "session_timeout_secs": 3600
    },
    "enable_apikey": true,
    "apikey_config": {
      "secret_length": 32,
      "hash_algo": "sha3-256",
      "default_expiry_days": 90,
      "allow_never_expire": false,
      "rate_limit_per_minute": 60
    }
  }
}

### 7. Update App Config - Relaxed for Development/Testing
# Best Practice: Easier settings for dev environment
PUT {{baseUrl}}/apps/dev-app
Content-Type: {{contentType}}

{
  "config": {
    "enable_basic": true,
    "basic_config": {
      "min_username_length": 3,
      "max_username_length": 32,
      "min_password_length": 6,
      "require_strong_pwd": false,
      "max_login_attempts": 10,
      "lockout_duration_secs": 60,
      "session_timeout_secs": 28800
    },
    "enable_apikey": true,
    "apikey_config": {
      "secret_length": 32,
      "hash_algo": "sha256",
      "default_expiry_days": 0,
      "allow_never_expire": true,
      "rate_limit_per_minute": 1000
    }
  }
}

### 8. Update App Config - API-Only (No User Auth)
# Best Practice: For service-to-service apps
PUT {{baseUrl}}/apps/api-gateway
Content-Type: {{contentType}}

{
  "config": {
    "enable_basic": false,
    "enable_oauth2": false,
    "enable_passwordless": false,
    "enable_passkey": false,
    "enable_apikey": true,
    "apikey_config": {
      "secret_length": 32,
      "hash_algo": "sha3-256",
      "default_expiry_days": 180,
      "allow_never_expire": false,
      "rate_limit_per_minute": 300
    }
  }
}

# =============================================================================
# WORKFLOW EXAMPLES
# =============================================================================

### WORKFLOW 1: Initial Tenant Setup
# Step 1: Create tenant (from tenant-service)
# Step 2: Set tenant default credential config
PUT {{baseUrl}}
Content-Type: {{contentType}}

{
  "config": {
    "enable_basic": true,
    "basic_config": {
      "min_password_length": 10,
      "require_strong_pwd": true,
      "max_login_attempts": 5,
      "lockout_duration_secs": 300,
      "session_timeout_secs": 3600
    },
    "enable_apikey": true,
    "apikey_config": {
      "secret_length": 32,
      "hash_algo": "sha3-256",
      "default_expiry_days": 365,
      "allow_never_expire": true,
      "rate_limit_per_minute": 100
    }
  }
}

# Step 3: All new apps will inherit this config

### WORKFLOW 2: Add OAuth2 to Existing Tenant
# Best Practice: Add Google and Azure SSO
PUT {{baseUrl}}
Content-Type: {{contentType}}

{
  "config": {
    "enable_oauth2": true,
    "oauth2_config": {
      "providers": [
        {
          "name": "google",
          "enabled": true,
          "client_id": "123456.apps.googleusercontent.com",
          "client_secret": "GOCSPX-secret",
          "scopes": ["openid", "email", "profile"]
        }
      ],
      "callback_url": "http://localhost:9090//api/auth/cred/oauth2/callback",
      "state_expiry_secs": 600,
      "session_timeout_secs": 7200
    }
  }
}

### WORKFLOW 3: Production App with Maximum Security
PUT {{baseUrl}}/apps/production-app
Content-Type: {{contentType}}

{
  "config": {
    "enable_basic": true,
    "basic_config": {
      "min_password_length": 16,
      "require_strong_pwd": true,
      "max_login_attempts": 3,
      "lockout_duration_secs": 3600,
      "session_timeout_secs": 900
    },
    "enable_passkey": true,
    "passkey_config": {
      "rp_name": "Acme Production",
      "rp_id": "acme-corp.com",
      "rp_origins": ["https://acme-corp.com", "https://www.acme-corp.com"],
      "require_resident_key": true,
      "user_verification": "required",
      "attestation_preference": "direct",
      "timeout_secs": 60
    },
    "enable_apikey": true,
    "apikey_config": {
      "secret_length": 32,
      "hash_algo": "sha3-256",
      "default_expiry_days": 30,
      "allow_never_expire": false,
      "rate_limit_per_minute": 30
    }
  }
}
