### API Key Auth Service API Tests
### Handles API key authentication (from core app keys)
@baseUrl = http://localhost:9090//api/auth/cred/apikey
@contentType = application/json
@apiKey = acme-corp.main-app.dev_a1b2c3d4e5f6

# Prerequisites:
# 1. Tenant must exist
# 2. App must exist
# 3. API Key must be created (from core/05-app-key-service.http)
# 4. API key auth must be enabled in credential config

# =============================================================================
# AUTHENTICATION
# =============================================================================

### 1. Authenticate with Valid API Key
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "{{apiKey}}",
  "scopes": ["read:users", "write:users"],
  "ip_address": "192.168.1.100",
  "user_agent": "MyApp/1.0"
}

### 2. Authenticate with Valid API Key - No Scopes
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "{{apiKey}}",
  "ip_address": "192.168.1.100",
  "user_agent": "MyApp/1.0"
}

### 3. Authenticate - Invalid API Key
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "invalid-key-format",
  "ip_address": "192.168.1.100"
}

### 4. Authenticate - Expired API Key
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "expired.apikey.example",
  "ip_address": "192.168.1.100"
}

### 5. Authenticate - Revoked API Key
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "revoked.apikey.example",
  "ip_address": "192.168.1.100"
}

### 6. Authenticate - Wrong Environment (production key in dev)
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "acme-corp.main-app.prod_x1y2z3a4b5c6",
  "ip_address": "192.168.1.100"
}

# =============================================================================
# SCOPE VALIDATION
# =============================================================================

### 7. Authenticate - Insufficient Scopes
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "{{apiKey}}",
  "scopes": ["admin:delete", "admin:create"],
  "ip_address": "192.168.1.100"
}

### 8. Authenticate - Partial Scopes Match
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "{{apiKey}}",
  "scopes": ["read:users", "admin:delete"],
  "ip_address": "192.168.1.100"
}

# =============================================================================
# WORKFLOW EXAMPLES
# =============================================================================

### WORKFLOW 1: Service-to-Service Authentication
# Step 1: Authenticate microservice A
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "acme-corp.main-app.dev_serviceA123",
  "scopes": ["read:orders", "write:orders"],
  "ip_address": "10.0.1.50",
  "user_agent": "OrderService/2.1"
}

# Step 2: Authenticate microservice B
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "acme-corp.main-app.dev_serviceB456",
  "scopes": ["read:inventory"],
  "ip_address": "10.0.1.51",
  "user_agent": "InventoryService/1.3"
}

### WORKFLOW 2: External Partner Integration
# Step 1: Partner authenticates with limited scope
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "acme-corp.partner-app.prod_partner789",
  "scopes": ["read:products", "read:prices"],
  "ip_address": "203.0.113.45",
  "user_agent": "PartnerIntegration/1.0"
}

# Step 2: Partner tries to access unauthorized scope (should fail)
POST {{baseUrl}}/authenticate
Content-Type: {{contentType}}

{
  "api_key": "acme-corp.partner-app.prod_partner789",
  "scopes": ["write:orders", "delete:customers"],
  "ip_address": "203.0.113.45",
  "user_agent": "PartnerIntegration/1.0"
}
