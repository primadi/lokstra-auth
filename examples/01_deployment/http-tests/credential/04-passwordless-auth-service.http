### Passwordless Auth Service API Tests
### Handles magic link and OTP authentication
@baseUrl = http://localhost:9090//api/auth/cred/passwordless
@contentType = application/json
@tenantId = acme-corp
@appId = main-app
@userEmail = john.doe@acme.com
@userPhone = +628123456789

# Prerequisites:
# 1. Tenant must exist
# 2. App must exist
# 3. Passwordless auth must be enabled in credential config
# 4. Email/SMS provider must be configured

# =============================================================================
# EMAIL CODE (OTP)
# =============================================================================

### 1. Send Verification Code via Email
POST {{baseUrl}}/send-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "{{userEmail}}",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

### 2. Verify Email Code
POST {{baseUrl}}/verify-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "{{userEmail}}",
  "code": "123456",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

### 3. Verify Email Code - Invalid Code
POST {{baseUrl}}/verify-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "{{userEmail}}",
  "code": "000000",
  "ip_address": "192.168.1.100"
}

### 4. Verify Email Code - Expired Code
POST {{baseUrl}}/verify-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "{{userEmail}}",
  "code": "999999",
  "ip_address": "192.168.1.100"
}

# =============================================================================
# SMS CODE (OTP)
# =============================================================================

### 5. Send Verification Code via SMS
POST {{baseUrl}}/send-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "sms",
  "identifier": "{{userPhone}}",
  "ip_address": "192.168.1.100",
  "user_agent": "MyApp/1.0"
}

### 6. Verify SMS Code
POST {{baseUrl}}/verify-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "sms",
  "identifier": "{{userPhone}}",
  "code": "654321",
  "ip_address": "192.168.1.100",
  "user_agent": "MyApp/1.0"
}

### 7. Verify SMS Code - Invalid Phone Number
POST {{baseUrl}}/verify-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "sms",
  "identifier": "+1234567890",
  "code": "123456"
}

# =============================================================================
# MAGIC LINK
# =============================================================================

### 8. Send Magic Link via Email
POST {{baseUrl}}/send-magic-link
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "email": "{{userEmail}}",
  "redirect_to": "https://acme.com/dashboard",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

### 9. Send Magic Link - Invalid Email
POST {{baseUrl}}/send-magic-link
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "email": "invalid-email-format",
  "redirect_to": "https://acme.com/dashboard"
}

### 10. Verify Magic Link (GET)
# This simulates clicking the magic link from email
# Token would be generated in step 8
GET {{baseUrl}}/verify-magic-link/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImpvaG4uZG9lQGFjbWUuY29tIn0.xyz

### 11. Verify Magic Link - Expired Token
GET {{baseUrl}}/verify-magic-link/expired-token-xyz

### 12. Verify Magic Link - Invalid Token
GET {{baseUrl}}/verify-magic-link/invalid-malformed-token

# =============================================================================
# RATE LIMITING
# =============================================================================

### 13. Send Code - Rate Limit Test (Attempt 1)
POST {{baseUrl}}/send-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "{{userEmail}}"
}

### 14. Send Code - Rate Limit Test (Attempt 2)
POST {{baseUrl}}/send-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "{{userEmail}}"
}

### 15. Send Code - Rate Limit Test (Attempt 3 - Should Fail)
POST {{baseUrl}}/send-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "{{userEmail}}"
}

# =============================================================================
# WORKFLOW EXAMPLES
# =============================================================================

### WORKFLOW 1: Email OTP Login
# Step 1: Request code
POST {{baseUrl}}/send-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "workflow@acme.com"
}

# Step 2: User receives code via email (e.g., 123456)

# Step 3: Verify code
POST {{baseUrl}}/verify-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "workflow@acme.com",
  "code": "123456"
}

# Response: { "access_token": "...", "user_id": "..." }

### WORKFLOW 2: SMS OTP Login
# Step 1: Request SMS code
POST {{baseUrl}}/send-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "sms",
  "identifier": "+628987654321"
}

# Step 2: User receives SMS with code

# Step 3: Verify SMS code
POST {{baseUrl}}/verify-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "sms",
  "identifier": "+628987654321",
  "code": "654321"
}

### WORKFLOW 3: Magic Link Login
# Step 1: Send magic link
POST {{baseUrl}}/send-magic-link
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "email": "magicuser@acme.com",
  "redirect_to": "https://acme.com/dashboard"
}

# Step 2: User clicks link in email
# GET /verify-magic-link/{token}
# Automatically redirects to dashboard with access token

### WORKFLOW 4: Failed Attempts & Rate Limiting
# Attempt 1
POST {{baseUrl}}/send-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "spam@acme.com"
}

# Attempt 2 (immediately)
POST {{baseUrl}}/send-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "spam@acme.com"
}

# Attempt 3 (should be rate limited)
POST {{baseUrl}}/send-code
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "method": "email",
  "identifier": "spam@acme.com"
}
