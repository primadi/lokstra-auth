### OAuth2 Auth Service API Tests
### Handles OAuth2 social login (Google, Azure, GitHub, etc.)
@baseUrl = http://localhost:9090//api/auth/cred/oauth2
@contentType = application/json
@tenantId = acme-corp
@appId = main-app
@provider = google

# Prerequisites:
# 1. Tenant must exist
# 2. App must exist
# 3. OAuth2 provider must be configured in credential config
# 4. OAuth2 credentials (client_id, client_secret) must be set

# =============================================================================
# AUTHORIZATION FLOW
# =============================================================================

### 1. Initiate OAuth2 Flow - Google
POST {{baseUrl}}/authorize
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "google"
}

### 2. Initiate OAuth2 Flow - Azure AD
POST {{baseUrl}}/authorize
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "azure"
}

### 3. Initiate OAuth2 Flow - GitHub
POST {{baseUrl}}/authorize
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "github"
}

### 4. Initiate OAuth2 Flow - Unsupported Provider
POST {{baseUrl}}/authorize
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "unsupported-provider"
}

# =============================================================================
# CALLBACK HANDLING
# =============================================================================

### 5. OAuth2 Callback - Success (Google)
# This simulates the callback from Google after user authorizes
# In real scenario, this is called by the OAuth2 provider redirect
GET {{baseUrl}}/callback?code=4/0AY0e-g7xyz&state=csrf-token-123
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

### 6. OAuth2 Callback - Invalid State (CSRF Protection)
GET {{baseUrl}}/callback?code=4/0AY0e-g7xyz&state=invalid-state-token
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

### 7. OAuth2 Callback - Missing Code
GET {{baseUrl}}/callback?state=csrf-token-123
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

### 8. OAuth2 Callback - Provider Error
GET {{baseUrl}}/callback?error=access_denied&error_description=User+denied+access&state=csrf-token-123
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

# =============================================================================
# TOKEN EXCHANGE
# =============================================================================

### 9. Exchange Code for Token (Manual)
# Normally handled automatically in callback, but can be called directly
POST {{baseUrl}}/token
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "google",
  "code": "4/0AY0e-g7xyz",
  "state": "csrf-token-123"
}

### 10. Refresh OAuth2 Token
POST {{baseUrl}}/refresh
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "google",
  "refresh_token": "1//0gxyz-refresh-token"
}

# =============================================================================
# USER INFO
# =============================================================================

### 11. Get User Info from OAuth2 Provider
POST {{baseUrl}}/userinfo
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "google",
  "access_token": "ya29.a0xyz-access-token"
}

# =============================================================================
# WORKFLOW EXAMPLES
# =============================================================================

### WORKFLOW 1: Complete OAuth2 Login Flow (Google)
# Step 1: Initiate authorization
POST {{baseUrl}}/authorize
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "google"
}

# Response: { "auth_url": "https://accounts.google.com/o/oauth2/v2/auth?...", "state": "abc123" }
# User is redirected to auth_url and grants permission

# Step 2: OAuth2 provider redirects back to callback
# GET /callback?code=4/0AY0e-g7xyz&state=abc123
# This happens automatically via browser redirect

# Step 3: Backend exchanges code for token and returns user info
# Returns: { "access_token": "...", "user": { ... } }

### WORKFLOW 2: Multi-Provider Setup
# Step 1: Configure Google OAuth2
POST {{baseUrl}}/authorize
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "google"
}

# Step 2: Configure Azure AD OAuth2
POST {{baseUrl}}/authorize
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "azure"
}

# Step 3: Configure GitHub OAuth2
POST {{baseUrl}}/authorize
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "github"
}

### WORKFLOW 3: Error Handling
# User denies authorization
GET {{baseUrl}}/callback?error=access_denied&error_description=User+denied+access&state=csrf-token-123

# Invalid code exchange
POST {{baseUrl}}/token
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "provider": "google",
  "code": "invalid-code-xyz",
  "state": "csrf-token-123"
}
