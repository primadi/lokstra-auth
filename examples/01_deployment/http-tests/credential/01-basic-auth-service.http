### Basic Auth Service API Tests
### Handles username/password authentication
@baseUrl = http://localhost:9090/api/auth/cred/basic
@contentType = application/json
@tenantId = acme-corp
@appId = main-app
@branchId = hq-jakarta

# Prerequisites: 
# 1. Tenant must exist
# 2. App must exist
# 3. User must be created (from core/04-user-service.http)
# 4. Basic auth must be enabled in credential config

# =============================================================================
# AUTHENTICATION
# =============================================================================

### 1. Login with Username & Password
POST {{baseUrl}}/login
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}
X-Branch-ID: {{branchId}}

{
  "username": "john.doe",
  "password": "NewSecurePass12345!",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

### 2. Login with Email & Password
POST {{baseUrl}}/login
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}
X-Branch-ID: {{branchId}}

{
  "username": "john.doe@example.com",
  "password": "NewSecurePass12345!",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

### 3. Login - Invalid Password
POST {{baseUrl}}/login
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}
X-Branch-ID: {{branchId}}

{
  "username": "john.doe",
  "password": "WrongPassword",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

### 4. Login - User Not Found
POST {{baseUrl}}/login
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}
X-Branch-ID: {{branchId}}

{
  "username": "nonexistent.user",
  "password": "AnyPassword123!",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

### 5. Login - Disabled User
POST {{baseUrl}}/login
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}
X-Branch-ID: {{branchId}}

{
  "username": "disabled.user",
  "password": "SecurePass123!",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

# =============================================================================
# PASSWORD MANAGEMENT
# =============================================================================

### 10. Change Password
POST {{baseUrl}}/change-password
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}

{
  "user_id": "john.doe",
  "old_password": "NewSecurePass12345!",
  "new_password": "NewSecurePass12345!"
}

### 11. Change Password - Wrong Old Password
POST {{baseUrl}}/change-password
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}

{
  "user_id": "user-id-here",
  "old_password": "WrongOldPassword",
  "new_password": "NewSecurePass456!"
}

### 12. Forgot Password - Request Reset Token
# User requests password reset via email
# Security: Always returns success (doesn't reveal if email exists)
POST {{baseUrl}}/forgot-password
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "email": "john.doe@example.com"
}

# Response: { "success": true, "message": "If the email exists, a password reset link has been sent" }
# In production: Reset token sent via email
# For testing: Token may be returned in response (disable in production!)

### 13. Forgot Password - Non-existent Email
# Security: Same response as valid email (prevents user enumeration)
POST {{baseUrl}}/forgot-password
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "email": "nonexistent@example.com"
}

### 14. Reset Password - Using Token from Email
# After receiving reset token via email, user submits new password
POST {{baseUrl}}/reset-password
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}

{
  "reset_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "new_password": "NewResetPassword123!"
}

### 15. Reset Password - Invalid Token
POST {{baseUrl}}/reset-password
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}

{
  "reset_token": "invalid-or-expired-token",
  "new_password": "NewResetPassword123!"
}

### 16. Reset Password - Token Reuse (Should Fail)
# Tokens should be single-use only
POST {{baseUrl}}/reset-password
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}

{
  "reset_token": "already-used-token",
  "new_password": "AnotherPassword123!"
}

# =============================================================================
# TOKEN MANAGEMENT
# =============================================================================

# NOTE: Token operations (refresh, logout/revoke, validate) are now handled by
# the generic Token Service at /api/auth/token/*
# 
# This separation of concerns means:
# - Basic Auth Service: Handles credential-specific operations (login, password management)
# - Token Service: Handles token operations (refresh, revoke, validate)
#
# See: ../token/01-token-service.http for token management endpoints
#
# Why this design?
# - All credential types (Basic, OAuth, API Key) generate the same JWT tokens
# - Token operations should be credential-agnostic
# - Better reusability and consistency across authentication methods

# =============================================================================
# WORKFLOW EXAMPLES
# =============================================================================

### WORKFLOW 1: Complete User Registration & Login
# Step 1: Register new user
POST {{baseUrl}}/register
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "username": "workflow.user",
  "email": "workflow@acme.com",
  "password": "WorkflowPass123!",
  "metadata": {
    "first_name": "Workflow",
    "last_name": "User"
  }
}

### Step 2: Login with new credentials
POST {{baseUrl}}/login
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "username": "workflow.user",
  "password": "WorkflowPass123!"
}

### Step 3: Change password
POST {{baseUrl}}/change-password
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}

{
  "user_id": "workflow-user-id",
  "old_password": "WorkflowPass123!",
  "new_password": "UpdatedPass456!"
}

### Step 4: Login with new password
POST {{baseUrl}}/login
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "username": "workflow.user",
  "password": "UpdatedPass456!"
}

### WORKFLOW 2: Failed Login Attempts (Testing Lockout)
# Attempt 1
POST {{baseUrl}}/login
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "username": "john.doe",
  "password": "WrongPassword1"
}

### Attempt 2
POST {{baseUrl}}/login
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "username": "john.doe",
  "password": "WrongPassword2"
}

### Attempt 3
POST {{baseUrl}}/login
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "username": "john.doe",
  "password": "WrongPassword3"
}

# ... After max_login_attempts (typically 5), account should be locked
