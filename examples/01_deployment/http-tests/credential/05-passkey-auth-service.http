### Passkey Auth Service API Tests
### Handles WebAuthn/FIDO2 passkey authentication
@baseUrl = http://localhost:9090//api/auth/cred/passkey
@contentType = application/json
@tenantId = acme-corp
@appId = main-app
@userId = user-123
@username = john.doe

# Prerequisites:
# 1. Tenant must exist
# 2. App must exist
# 3. User must exist
# 4. Passkey auth must be enabled in credential config
# 5. Browser must support WebAuthn API

# =============================================================================
# REGISTRATION FLOW
# =============================================================================

### 1. Begin Passkey Registration
POST {{baseUrl}}/registration/begin
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "user_id": "{{userId}}",
  "username": "{{username}}",
  "email": "john.doe@acme.com",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

# Response contains WebAuthn PublicKeyCredentialCreationOptions:
# {
#   "challenge": "base64-encoded-random-bytes",
#   "rp": { "name": "Acme Corp", "id": "acme.com" },
#   "user": { "id": "user-123", "name": "john.doe", "displayName": "John Doe" },
#   "pubKeyCredParams": [{ "type": "public-key", "alg": -7 }],
#   ...
# }

### 2. Finish Passkey Registration
# This simulates the response from navigator.credentials.create()
POST {{baseUrl}}/registration/finish
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "user_id": "{{userId}}",
  "credential_id": "base64-encoded-credential-id",
  "client_data_json": "base64-encoded-client-data",
  "attestation_object": "base64-encoded-attestation",
  "transports": ["internal", "hybrid"],
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

### 3. Begin Registration - User Already Has Passkey
POST {{baseUrl}}/registration/begin
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "user_id": "{{userId}}",
  "username": "{{username}}",
  "email": "john.doe@acme.com"
}

### 4. Finish Registration - Invalid Attestation
POST {{baseUrl}}/registration/finish
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "user_id": "{{userId}}",
  "credential_id": "invalid-credential-id",
  "client_data_json": "invalid-data",
  "attestation_object": "invalid-attestation"
}

# =============================================================================
# AUTHENTICATION FLOW
# =============================================================================

### 5. Begin Passkey Authentication (with username)
POST {{baseUrl}}/authentication/begin
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "username": "{{username}}",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

# Response contains WebAuthn PublicKeyCredentialRequestOptions:
# {
#   "challenge": "base64-encoded-random-bytes",
#   "rpId": "acme.com",
#   "allowCredentials": [
#     { "type": "public-key", "id": "base64-credential-id", "transports": ["internal"] }
#   ],
#   "userVerification": "preferred",
#   ...
# }

### 6. Begin Passkey Authentication (usernameless/discoverable)
POST {{baseUrl}}/authentication/begin
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

### 7. Finish Passkey Authentication
# This simulates the response from navigator.credentials.get()
POST {{baseUrl}}/authentication/finish
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "credential_id": "base64-encoded-credential-id",
  "client_data_json": "base64-encoded-client-data",
  "authenticator_data": "base64-encoded-auth-data",
  "signature": "base64-encoded-signature",
  "user_handle": "base64-encoded-user-handle",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0"
}

### 8. Finish Authentication - Invalid Signature
POST {{baseUrl}}/authentication/finish
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "credential_id": "base64-encoded-credential-id",
  "client_data_json": "base64-encoded-client-data",
  "authenticator_data": "base64-encoded-auth-data",
  "signature": "invalid-signature",
  "user_handle": "base64-encoded-user-handle"
}

### 9. Finish Authentication - Revoked Credential
POST {{baseUrl}}/authentication/finish
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "credential_id": "revoked-credential-id",
  "client_data_json": "base64-encoded-client-data",
  "authenticator_data": "base64-encoded-auth-data",
  "signature": "base64-encoded-signature"
}

# =============================================================================
# CREDENTIAL MANAGEMENT
# =============================================================================

### 10. List User's Passkeys
GET {{baseUrl}}/credentials/{{userId}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

### 11. Get Specific Passkey Details
GET {{baseUrl}}/credentials/{{userId}}/credential-id-here
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

### 12. Revoke Passkey
DELETE {{baseUrl}}/credentials/{{userId}}/credential-id-here
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

### 13. Update Passkey Name
PATCH {{baseUrl}}/credentials/{{userId}}/credential-id-here
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "device_name": "My iPhone 15 Pro"
}

# =============================================================================
# WORKFLOW EXAMPLES
# =============================================================================

### WORKFLOW 1: Complete Passkey Registration
# Step 1: Begin registration ceremony
POST {{baseUrl}}/registration/begin
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "user_id": "new-user-456",
  "username": "jane.smith",
  "email": "jane.smith@acme.com"
}

# Step 2: Browser calls navigator.credentials.create() with options
# User authenticates with biometrics/PIN

# Step 3: Send credential to backend
POST {{baseUrl}}/registration/finish
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "user_id": "new-user-456",
  "credential_id": "credential-from-browser",
  "client_data_json": "client-data-from-browser",
  "attestation_object": "attestation-from-browser",
  "transports": ["internal"]
}

# Response: { "success": true, "credential_id": "...", "device_name": "iPhone" }

### WORKFLOW 2: Passkey Authentication
# Step 1: Begin authentication
POST {{baseUrl}}/authentication/begin
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "username": "jane.smith"
}

# Step 2: Browser calls navigator.credentials.get() with options
# User authenticates with biometrics/PIN

# Step 3: Send assertion to backend
POST {{baseUrl}}/authentication/finish
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "credential_id": "credential-id-from-browser",
  "client_data_json": "client-data-from-browser",
  "authenticator_data": "auth-data-from-browser",
  "signature": "signature-from-browser",
  "user_handle": "user-handle-from-browser"
}

# Response: { "success": true, "access_token": "...", "user_id": "new-user-456" }

### WORKFLOW 3: Usernameless/Discoverable Credentials
# Step 1: Begin authentication without username
POST {{baseUrl}}/authentication/begin
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "ip_address": "192.168.1.100"
}

# Step 2: Browser shows list of available passkeys
# User selects one and authenticates

# Step 3: Send assertion
POST {{baseUrl}}/authentication/finish
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "credential_id": "selected-credential",
  "client_data_json": "client-data",
  "authenticator_data": "auth-data",
  "signature": "signature",
  "user_handle": "user-handle"
}

### WORKFLOW 4: Multi-Device Passkey Management
# Step 1: Register passkey on iPhone
POST {{baseUrl}}/registration/begin
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "user_id": "{{userId}}",
  "username": "{{username}}",
  "email": "john.doe@acme.com"
}

# Complete registration...

# Step 2: Register passkey on MacBook
POST {{baseUrl}}/registration/begin
Content-Type: {{contentType}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

{
  "user_id": "{{userId}}",
  "username": "{{username}}",
  "email": "john.doe@acme.com"
}

# Complete registration...

# Step 3: List all devices
GET {{baseUrl}}/credentials/{{userId}}
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}

# Step 4: Revoke lost device
DELETE {{baseUrl}}/credentials/{{userId}}/old-phone-credential-id
X-Tenant-ID: {{tenantId}}
X-App-ID: {{appId}}
